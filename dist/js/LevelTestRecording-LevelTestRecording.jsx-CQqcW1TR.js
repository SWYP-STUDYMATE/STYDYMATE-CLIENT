import{b as e,z as t}from"./vendor-chunk-D6LsFSV7.js";import{C as r}from"./CommonButton-chunk-BGn4hO1n.js";import{u as s,s as n,c as a}from"./levelTestStore-chunk-B4uhrPXk.js";import{f as c,e as l,d as i,g as o,n as d,o as u,p as m,q as x}from"./ui-vendor-chunk-CYPVLLJ1.js";import{u as h}from"./react-vendor-chunk-CMkIwBz9.js";import"./utils-vendor-chunk-Clitctyl.js";const f=({onRecordingComplete:r,disabled:n=!1})=>{const[a,d]=e.useState(!1),[u,m]=e.useState(!1),[x,h]=e.useState(0),[f,p]=e.useState(0),b=e.useRef(null),j=e.useRef([]),g=e.useRef(null),v=e.useRef(null),w=e.useRef(null),N=e.useRef(null),y=e.useRef(null),{startRecording:k,stopRecording:C,updateRecordingDuration:S}=s();e.useEffect(()=>()=>{y.current&&y.current.getTracks().forEach(e=>e.stop()),w.current&&cancelAnimationFrame(w.current),N.current&&clearInterval(N.current)},[]);const F=()=>{if(!v.current)return;const e=new Uint8Array(v.current.frequencyBinCount);v.current.getByteFrequencyData(e);const t=e.reduce((e,t)=>e+t)/e.length;p(Math.min(t/128,1)),w.current=requestAnimationFrame(F)};return t.jsxs("div",{className:"flex flex-col items-center space-y-6",children:[t.jsx("div",{className:"w-full max-w-md h-24 bg-[#F8F9FA] rounded-lg p-4 flex items-center justify-center",children:a&&!u?t.jsx("div",{className:"flex items-center space-x-1 h-full",children:[...Array(20)].map((e,r)=>t.jsx("div",{className:"w-3 bg-[#00C471] rounded-full transition-all duration-100",style:{height:Math.random()*f*100+"%",opacity:.8}},r))}):t.jsx("p",{className:"text-[#929292] text-sm",children:a?"일시정지":"녹음 대기 중"})}),t.jsx("div",{className:"text-2xl font-bold text-[#111111]",children:(e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`})(x)}),t.jsx("div",{className:"flex items-center space-x-4",children:a?t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>{b.current&&a&&(u?(b.current.resume(),N.current=setInterval(()=>{h(e=>{const t=e+1;return S(t),t})},1e3),F()):(b.current.pause(),N.current&&clearInterval(N.current),w.current&&cancelAnimationFrame(w.current)),m(!u))},className:"w-14 h-14 bg-[#4285F4] hover:bg-[#3374E0] text-white rounded-full flex items-center justify-center transition-colors duration-200",children:u?t.jsx(l,{className:"w-6 h-6"}):t.jsx(i,{className:"w-6 h-6"})}),t.jsx("button",{onClick:()=>{b.current&&a&&(b.current.stop(),d(!1),m(!1),N.current&&clearInterval(N.current),w.current&&cancelAnimationFrame(w.current),p(0),C())},className:"w-16 h-16 bg-[#111111] hover:bg-[#414141] text-white rounded-full flex items-center justify-center transition-colors duration-200",children:t.jsx(o,{className:"w-8 h-8"})})]}):t.jsx("button",{onClick:async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100}});y.current=e,g.current=new(window.AudioContext||window.webkitAudioContext),v.current=g.current.createAnalyser();g.current.createMediaStreamSource(e).connect(v.current),v.current.fftSize=256;const t={mimeType:"audio/webm;codecs=opus"};MediaRecorder.isTypeSupported(t.mimeType)||(t.mimeType="audio/webm"),b.current=new MediaRecorder(e,t),j.current=[],b.current.ondataavailable=e=>{e.data.size>0&&j.current.push(e.data)},b.current.onstop=()=>{const t=new Blob(j.current,{type:"audio/webm"});k(t),r&&r(t),e.getTracks().forEach(e=>e.stop()),g.current&&g.current.close()},b.current.start(),d(!0),h(0),N.current=setInterval(()=>{h(e=>{const t=e+1;return S(t),t})},1e3),F()}catch(e){alert("마이크 접근 권한이 필요합니다.")}},disabled:n,className:"w-16 h-16 bg-[#EA4335] hover:bg-[#D33B2C] text-white rounded-full flex items-center justify-center transition-colors duration-200 disabled:bg-[#F1F3F5] disabled:cursor-not-allowed",children:t.jsx(c,{className:"w-8 h-8"})})}),t.jsx("div",{className:"text-center",children:t.jsx("p",{className:"text-sm text-[#929292]",children:a?"녹음 중입니다. 정지 버튼을 눌러 녹음을 완료하세요.":"마이크 버튼을 눌러 녹음을 시작하세요."})})]})},p=({duration:r=180,onTimeUp:n,autoStart:a=!1})=>{const c=e.useRef(null),{timerSeconds:l,isTimerRunning:i,setTimerSeconds:o,startTimer:m,stopTimer:x,decrementTimer:h}=s();e.useEffect(()=>(o(r),a&&m(),()=>{c.current&&clearInterval(c.current)}),[r,a,o,m]),e.useEffect(()=>(i&&l>0?c.current=setInterval(()=>{h()},1e3):(c.current&&clearInterval(c.current),0===l&&i&&(x(),n&&n())),()=>{c.current&&clearInterval(c.current)}),[i,l,h,x,n]);const f=l<=30;return t.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[t.jsxs("div",{className:"relative w-48 h-48",children:[t.jsxs("svg",{className:"transform -rotate-90 w-48 h-48",children:[t.jsx("circle",{cx:"96",cy:"96",r:"88",stroke:"#E7E7E7",strokeWidth:"8",fill:"none"}),t.jsx("circle",{cx:"96",cy:"96",r:"88",stroke:(()=>{const e=l/r*100;return e>50?"#00C471":e>20?"#FFA500":"#EA4335"})(),strokeWidth:"8",fill:"none",strokeDasharray:""+2*Math.PI*88,strokeDashoffset:""+2*Math.PI*88*((r-l)/r*100/100),className:"transition-all duration-1000 ease-linear",strokeLinecap:"round"})]}),t.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[t.jsx(d,{className:"w-8 h-8 mb-2 "+(f?"text-[#EA4335]":"text-[#929292]")}),t.jsx("div",{className:"text-3xl font-bold "+(f?"text-[#EA4335]":"text-[#111111]"),children:(e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`})(l)}),f&&t.jsx("div",{className:"text-sm text-[#EA4335] mt-1 animate-pulse",children:"시간 초과 임박"})]})]}),t.jsxs("div",{className:"flex items-center space-x-4",children:[i?t.jsx("button",{onClick:x,className:"px-6 py-2 bg-[#929292] hover:bg-[#606060] text-white rounded-lg font-medium transition-colors duration-200",children:"타이머 정지"}):t.jsx("button",{onClick:m,className:"px-6 py-2 bg-[#00C471] hover:bg-[#00B267] text-white rounded-lg font-medium transition-colors duration-200",children:"타이머 시작"}),t.jsx("button",{onClick:()=>o(r),className:"px-6 py-2 bg-white hover:bg-[#F8F9FA] text-[#111111] border border-[#E7E7E7] rounded-lg font-medium transition-colors duration-200",children:"리셋"})]}),f&&t.jsxs("div",{className:"flex items-center space-x-2 p-3 bg-[#FFF4E6] rounded-lg",children:[t.jsx(u,{className:"w-5 h-5 text-[#FFA500]"}),t.jsx("p",{className:"text-sm text-[#606060]",children:"남은 시간이 30초 이하입니다. 답변을 마무리해주세요."})]}),t.jsx("div",{className:"text-center max-w-md",children:t.jsxs("p",{className:"text-sm text-[#929292]",children:["각 질문당 ",Math.floor(r/60),"분의 시간이 주어집니다. 시간 내에 답변을 완료해주세요."]})})]})};function b(){const c=h(),[l,i]=e.useState(!1),{currentQuestionIndex:o,totalQuestions:d,questions:u,recordings:b,nextQuestion:j,previousQuestion:g,setTestStatus:v,addRecording:w,setCurrentRecording:N,clearCurrentRecording:y,getRecordingForQuestion:k,isCurrentQuestionRecorded:C,isTestComplete:S,resetTimer:F,stopTimer:E,loadQuestions:R,submitTest:T,isSubmitting:A,submitError:I}=s(),M=u[o],q=C();k(o),e.useEffect(()=>(v("recording"),i(!0),0===u.length&&R(),()=>{E(),y()}),[v,E,y,R,u.length]),e.useEffect(()=>{F(),i(!1),setTimeout(()=>i(!0),100)},[o,F]);const Q=async()=>{if(q&&!A)try{setIsSubmitting(!0);const e=localStorage.getItem("userId")||"guest";if(await n(currentRecording.blob,o+1),o<d-1)j();else{v("processing");const t=await a(e);setTestResult(t),c("/level-test/result")}}catch(e){alert("테스트 제출에 실패했습니다. 다시 시도해주세요.")}finally{setIsSubmitting(!1)}else q||(o<d-1?j():c("/level-test/result"))};return t.jsxs("div",{className:"min-h-screen page-bg flex flex-col",children:[t.jsx("div",{className:"bg-white border-b border-[#E7E7E7] px-6 py-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("button",{onClick:()=>c("/level-test/check"),className:"p-2 -ml-2",children:t.jsx(m,{className:"w-6 h-6 text-[var(--black-500)]"})}),t.jsxs("h1",{className:"text-[18px] font-bold text-[#111111]",children:["질문 ",o+1," / ",d]}),t.jsx("div",{className:"w-10"})]})}),t.jsx("div",{className:"bg-white px-6 py-3",children:t.jsx("div",{className:"h-2 bg-[var(--black-50)] rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-[var(--green-500)] transition-all duration-300",style:{width:(o+1)/d*100+"%"}})})}),t.jsxs("div",{className:"flex-1 flex flex-col items-center px-6 py-8",children:[t.jsxs("div",{className:"w-full max-w-2xl bg-white rounded-[20px] p-6 mb-8 border border-[var(--black-50)]",children:[t.jsx("p",{className:"text-[20px] font-bold text-[var(--black-500)] mb-3",children:M?.text||M?.question||""}),t.jsx("p",{className:"text-[16px] text-[var(--black-300)]",children:M?.korean||""})]}),t.jsx("div",{className:"mb-8",children:t.jsx(p,{duration:M?.duration||180,onTimeUp:()=>{q||(alert("시간이 초과되었습니다. 다음 질문으로 이동합니다."),Q())},autoStart:l})}),t.jsx("div",{className:"mb-8 w-full max-w-md",children:t.jsx(f,{onRecordingComplete:e=>{w({blob:e,duration:0}),i(!1)},disabled:q})}),t.jsxs("div",{className:"w-full max-w-md space-y-3",children:[q&&t.jsxs(t.Fragment,{children:[t.jsx(r,{onClick:()=>{b.filter(e=>e.questionIndex!==o),F(),i(!0)},variant:"secondary",className:"w-full",children:"다시 녹음하기"}),t.jsx(r,{onClick:Q,variant:"primary",className:"w-full",disabled:A,children:A?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white inline-block mr-2"}),"제출 중..."]}):t.jsxs(t.Fragment,{children:[o<d-1?"다음 질문":"테스트 완료",t.jsx(x,{className:"w-5 h-5 ml-2"})]})})]}),o>0&&t.jsxs(r,{onClick:()=>{o>0&&g()},variant:"secondary",className:"w-full",children:[t.jsx(m,{className:"w-5 h-5 mr-2"}),"이전 질문"]})]}),!q&&t.jsx("button",{onClick:Q,className:"mt-4 text-[#929292] text-sm underline",children:"이 질문 건너뛰기 (테스트용)"})]})]})}export{b as default};
