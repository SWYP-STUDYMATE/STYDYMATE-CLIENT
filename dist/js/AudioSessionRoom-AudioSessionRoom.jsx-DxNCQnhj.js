import{b as e,z as t}from"./vendor-chunk-D6LsFSV7.js";import{V as a}from"./VideoControls-chunk-LrBTXWiJ.js";import{n as s,L as n,O as r,b as c,I as i,Q as l}from"./ui-vendor-chunk-CYPVLLJ1.js";import{u as o,e as d}from"./react-vendor-chunk-CMkIwBz9.js";const u=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}];function m(){const m=o(),{roomId:x}=d(),[h,p]=e.useState(0),[f,g]=e.useState("ko"),b=e.useRef(null),j=e.useRef(null),w=e.useRef(null),N=e.useRef(new Map),y=localStorage.getItem("userId")||"user-"+Date.now(),{connectionState:v,localStream:S,remoteStreams:k,isAudioEnabled:E,stats:C,error:A,toggleAudio:O,disconnect:T}=function(t,a){const[s,n]=e.useState("new"),[r,c]=e.useState(null),[i,l]=e.useState(new Map),[o,d]=e.useState(!0),[m,x]=e.useState(!0),[h,p]=e.useState(null),[f,g]=e.useState({bitrate:0,packetLoss:0,latency:0,quality:"good"}),b=e.useRef(null),j=e.useRef(new Map),w=e.useRef(null),N=e.useRef(null),y=e.useCallback(async(e={})=>{try{const t={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1!==e.video&&{width:{ideal:1280,max:1920},height:{ideal:720,max:1080},frameRate:{ideal:24,max:30}}},a=await navigator.mediaDevices.getUserMedia({...t,...e});return w.current=a,c(a),p(null),a}catch(t){if(p(t.message),"NotFoundError"===t.name&&!1!==e.video)return y({video:!1});throw t}},[]),v=e.useCallback(()=>{if(!a)return;const e=`${"https://studymate-api.wjstks3474.workers.dev".replace("https","wss")}/api/room/${t}/ws`,s=new WebSocket(e);return s.onopen=()=>{n("connecting"),s.send(JSON.stringify({type:"join",userId:a,userName:a}))},s.onmessage=async e=>{const t=JSON.parse(e.data);switch(t.type){case"connected":break;case"participant-joined":await S(t.participant.id,!0);break;case"participant-left":T(t.participantId);break;case"offer":await k(t.from,t.data);break;case"answer":await E(t.from,t.data);break;case"ice-candidate":await C(t.from,t.data);break;case"participant-updated":A(t.participant)}},s.onerror=e=>{p("연결 오류가 발생했습니다")},s.onclose=()=>{n("disconnected"),setTimeout(()=>{b.current===s&&v()},3e3)},b.current=s,s},[t,a]),S=e.useCallback(async(e,t=!1)=>{const a=new RTCPeerConnection({iceServers:u});if(j.current.set(e,a),w.current&&w.current.getTracks().forEach(e=>{a.addTrack(e,w.current)}),a.onicecandidate=t=>{t.candidate&&b.current?.readyState===WebSocket.OPEN&&b.current.send(JSON.stringify({type:"ice-candidate",data:{to:e,signal:t.candidate}}))},a.ontrack=t=>{l(a=>new Map(a).set(e,t.streams[0]))},a.onconnectionstatechange=()=>{"connected"===a.connectionState?(n("connected"),M(a,e)):"failed"===a.connectionState&&O(e)},t)try{const t=await a.createOffer();await a.setLocalDescription(t),b.current?.readyState===WebSocket.OPEN&&b.current.send(JSON.stringify({type:"offer",data:{to:e,signal:t}}))}catch(s){p("연결 생성 실패")}return a},[]),k=e.useCallback(async(e,t)=>{try{const a=await S(e,!1);await a.setRemoteDescription(new RTCSessionDescription(t));const s=await a.createAnswer();await a.setLocalDescription(s),b.current?.readyState===WebSocket.OPEN&&b.current.send(JSON.stringify({type:"answer",data:{to:e,signal:s}}))}catch(a){p("연결 수락 실패")}},[S]),E=e.useCallback(async(e,t)=>{const a=j.current.get(e);if(a)try{await a.setRemoteDescription(new RTCSessionDescription(t))}catch(s){p("연결 설정 실패")}},[]),C=e.useCallback(async(e,t)=>{const a=j.current.get(e);if(a&&t)try{await a.addIceCandidate(new RTCIceCandidate(t))}catch(s){}},[]),A=e.useCallback(e=>{},[]),O=e.useCallback(e=>{const t=j.current.get(e);t&&t.restartIce()},[]),T=e.useCallback(e=>{const t=j.current.get(e);t&&(t.close(),j.current.delete(e)),l(t=>{const a=new Map(t);return a.delete(e),a})},[]),M=e.useCallback((e,t)=>{const a=setInterval(async()=>{if("connected"===e.connectionState)try{const t=await e.getStats();let a=0,s=0,n=0,r=[];t.forEach(e=>{"outbound-rtp"===e.type&&"video"===e.kind&&(a+=8*e.bytesSent/e.timestamp,s+=e.packetsLost||0,n+=e.packetsSent||0),"candidate-pair"===e.type&&"succeeded"===e.state&&e.currentRoundTripTime&&r.push(1e3*e.currentRoundTripTime)});const c=n>0?s/n:0,i=r.length>0?r.reduce((e,t)=>e+t)/r.length:0;let l="good";(c>.05||i>150)&&(l="fair"),(c>.1||i>300)&&(l="poor"),g({bitrate:Math.round(a/1e3),packetLoss:Math.round(100*c),latency:Math.round(i),quality:l})}catch(t){}else clearInterval(a)},2e3);return a},[]),R=e.useCallback(()=>{if(w.current){const e=w.current.getAudioTracks();e.forEach(e=>{e.enabled=!e.enabled});const t=e[0]?.enabled??!1;d(t),b.current?.readyState===WebSocket.OPEN&&b.current.send(JSON.stringify({type:"toggle-audio",data:{enabled:t}}))}},[]),I=e.useCallback(()=>{if(w.current){const e=w.current.getVideoTracks();e.forEach(e=>{e.enabled=!e.enabled});const t=e[0]?.enabled??!1;x(t),b.current?.readyState===WebSocket.OPEN&&b.current.send(JSON.stringify({type:"toggle-video",data:{enabled:t}}))}},[]),D=e.useCallback(()=>{j.current.forEach((e,t)=>{T(t)}),w.current&&(w.current.getTracks().forEach(e=>e.stop()),w.current=null,c(null)),b.current&&(b.current.close(),b.current=null),N.current&&clearInterval(N.current),n("disconnected"),l(new Map)},[T]);return e.useEffect(()=>{if(a)return(async()=>{try{await y(),v()}catch(e){p("초기화 실패: "+e.message)}})(),()=>{D()}},[t,a]),{connectionState:s,localStream:r,remoteStreams:i,isAudioEnabled:o,isVideoEnabled:m,error:h,stats:f,toggleAudio:R,toggleVideo:I,disconnect:D,getUserMedia:y}}(x||"default-room",y);e.useEffect(()=>{S&&w.current&&(w.current.srcObject=S)},[S]),e.useEffect(()=>{k.forEach((e,t)=>{let a=N.current.get(t);a||(a=document.createElement("audio"),a.autoplay=!0,a.id=`remote-audio-${t}`,document.body.appendChild(a),N.current.set(t,a)),a.srcObject!==e&&(a.srcObject=e)}),N.current.forEach((e,t)=>{k.has(t)||(e.srcObject=null,e.remove(),N.current.delete(t))})},[k]),e.useEffect(()=>("connected"!==v||j.current||(j.current=Date.now(),b.current=setInterval(()=>{const e=Math.floor((Date.now()-j.current)/1e3);p(e)},1e3)),()=>{b.current&&clearInterval(b.current)}),[v]),e.useEffect(()=>()=>{N.current.forEach(e=>{e.srcObject=null,e.remove()}),N.current.clear()},[]);return t.jsxs("div",{className:"min-h-screen bg-[#0F0F0F] flex flex-col",children:[t.jsx("div",{className:"bg-[#1A1A1A] px-6 py-4",children:t.jsxs("div",{className:"max-w-7xl mx-auto flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("h1",{className:"text-white text-[18px] font-medium",children:"음성 세션"}),"connected"===v&&t.jsxs("div",{className:"flex items-center gap-4 text-[#929292] text-sm",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(s,{className:"w-4 h-4"}),t.jsx("span",{children:(e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60),s=e%60;return t>0?`${t}:${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${a}:${s.toString().padStart(2,"0")}`})(h)})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[(()=>{switch(C.quality){case"good":return t.jsx(i,{className:"w-4 h-4 text-[#00C471]"});case"fair":return t.jsx(i,{className:"w-4 h-4 text-[#FFA500]"});case"poor":return t.jsx(l,{className:"w-4 h-4 text-[#EA4335]"});default:return t.jsx(i,{className:"w-4 h-4 text-[#929292]"})}})(),t.jsx("span",{children:C.latency>0?`${C.latency}ms`:"연결 확인 중"})]}),t.jsxs("div",{className:"text-sm text-[#E7E7E7]",children:["참가자: ",k.size+1,"명"]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-[#929292] text-sm",children:"현재 언어:"}),t.jsx("span",{className:"text-white text-sm font-medium",children:(M=f,{ko:"한국어",en:"English",ja:"日本語",zh:"中文",es:"Español"}[M]||M)})]})]})}),t.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:t.jsxs("div",{className:"max-w-4xl w-full",children:[t.jsxs("div",{className:"text-center mb-12",children:["new"===v&&t.jsxs("div",{className:"text-[#606060]",children:[t.jsx(n,{className:"w-12 h-12 animate-spin mx-auto mb-4"}),t.jsx("p",{className:"text-lg",children:"연결 준비 중..."})]}),"connecting"===v&&t.jsxs("div",{className:"text-[#4285F4]",children:[t.jsx(r,{className:"w-16 h-16 animate-pulse mx-auto mb-4"}),t.jsx("p",{className:"text-xl font-medium",children:"상대방과 연결 중입니다..."})]}),"connected"===v&&t.jsxs("div",{children:[t.jsxs("div",{className:"relative inline-block mb-6",children:[t.jsx("div",{className:"w-48 h-48 rounded-full bg-[#1A1A1A] flex items-center justify-center",children:t.jsx(c,{className:"w-24 h-24 text-[#00C471]"})}),t.jsxs("div",{className:"absolute inset-0 rounded-full",children:[t.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-[#00C471] animate-ping"}),t.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-[#00C471]"})]})]}),t.jsx("h2",{className:"text-white text-[28px] font-bold mb-4",children:"통화 연결됨"}),t.jsxs("p",{className:"text-[#00C471] text-lg mb-2",children:[k.size,"명의 참가자와 통화 중"]}),t.jsxs("div",{className:"flex items-center justify-center gap-6 mt-6 text-sm text-[#929292]",children:[t.jsxs("div",{children:["비트레이트: ",C.bitrate,"kbps"]}),t.jsxs("div",{children:["패킷 손실: ",C.packetLoss,"%"]}),t.jsxs("div",{children:["지연시간: ",C.latency,"ms"]})]})]}),"disconnected"===v&&t.jsxs("div",{className:"text-[#EA4335]",children:[t.jsx(c,{className:"w-16 h-16 mx-auto mb-4"}),t.jsx("p",{className:"text-xl font-medium",children:"통화가 종료되었습니다"})]}),"failed"===v&&t.jsxs("div",{className:"text-[#EA4335]",children:[t.jsx(c,{className:"w-16 h-16 mx-auto mb-4"}),t.jsx("p",{className:"text-xl font-medium",children:"연결 실패"}),t.jsx("p",{className:"text-sm mt-2",children:"네트워크 상태를 확인해주세요"})]})]}),A&&t.jsx("div",{className:"bg-[#EA4335]/10 border border-[#EA4335] rounded-lg p-4 mb-8 text-center",children:t.jsx("p",{className:"text-[#EA4335]",children:A})}),"connected"===v&&t.jsxs("div",{className:"bg-[#1A1A1A] rounded-lg p-6 mb-8",children:[t.jsx("div",{className:"flex items-center justify-center h-24",children:t.jsx("div",{className:"flex items-center gap-1",children:[...Array(20)].map((e,a)=>t.jsx("div",{className:"w-2 bg-[#00C471] rounded-full animate-pulse",style:{height:60*Math.random()+20+"px",animationDelay:.1*a+"s",animationDuration:"1.5s"}},a))})}),t.jsx("p",{className:"text-center text-[#929292] text-sm mt-4",children:"음성 통화 진행 중..."})]})]})}),t.jsx("div",{className:"bg-[#0F0F0F] p-6",children:t.jsx("div",{className:"max-w-4xl mx-auto",children:t.jsx(a,{isMuted:!E,onToggleMute:O,onEndCall:()=>{T(),b.current&&clearInterval(b.current),setTimeout(()=>{m("/sessions")},1e3)},onToggleLanguage:()=>{const e=["ko","en","ja","zh","es"],t=(e.indexOf(f)+1)%e.length;g(e[t])},currentLanguage:f,showVideo:!1,showScreenShare:!1,showLanguageToggle:!0,showFullscreen:!1,showSettings:!1,showParticipants:!1,variant:"dark"})})}),t.jsx("audio",{ref:w,muted:!0,autoPlay:!0,style:{display:"none"}})]});var M}export{m as default};
