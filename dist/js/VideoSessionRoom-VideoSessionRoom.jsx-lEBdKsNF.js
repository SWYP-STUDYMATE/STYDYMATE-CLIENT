import{b as e,z as t}from"./vendor-chunk-3fnplnT6.js";import{V as r}from"./VideoControls-chunk-C3ODz-9o.js";import{U as n,v as s,w as c,x as a,L as i,y as l,z as o}from"./ui-vendor-chunk-DkBAET_w.js";import{u as d,e as u}from"./react-vendor-chunk-COHvxYfz.js";function m(){const m=d(),{roomId:x}=u(),[h,g]=e.useState("connecting"),[f,p]=e.useState(!1),[j,w]=e.useState(!0),[N,v]=e.useState(!1),[b,y]=e.useState(0),[S,k]=e.useState(3),[P,A]=e.useState("en"),[T,E]=e.useState(!1),[O,C]=e.useState(!1),[I,R]=e.useState({name:"John Doe",avatar:"/assets/basicProfilePic.png",level:"B2",nativeLanguage:"English",learningLanguage:"Korean"}),D=e.useRef(null),J=e.useRef(null),L=e.useRef(null),V=e.useRef(null),M=e.useRef(null),W=e.useRef(null),$=e.useRef(null),B=e.useRef(null),z={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};e.useEffect(()=>(C("pictureInPictureEnabled"in document),U(),()=>{_()}),[x]),e.useEffect(()=>("connected"===h?B.current=setInterval(()=>{y(e=>e+1)},1e3):B.current&&clearInterval(B.current),()=>{B.current&&clearInterval(B.current)}),[h]);const U=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});D.current=e,M.current&&(M.current.srcObject=e),q(),F()}catch(e){g("failed")}},q=()=>{$.current=new WebSocket(`wss://your-signaling-server.com/room/${x}`),$.current.onopen=()=>{$.current.send(JSON.stringify({type:"join",roomId:x}))},$.current.onmessage=async e=>{const t=JSON.parse(e.data);switch(t.type){case"offer":await K(t.offer);break;case"answer":await H(t.answer);break;case"ice-candidate":await Q(t.candidate);break;case"user-joined":await G();break;case"user-left":X();break;case"screen-share-started":Y(!0);break;case"screen-share-stopped":Y(!1)}},$.current.onerror=e=>{g("failed")},$.current.onclose=()=>{g("disconnected")}},F=()=>{V.current=new RTCPeerConnection(z),D.current&&D.current.getTracks().forEach(e=>{V.current.addTrack(e,D.current)}),V.current.ontrack=e=>{J.current=e.streams[0],W.current&&(W.current.srcObject=e.streams[0]),g("connected")},V.current.onicecandidate=e=>{e.candidate&&$.current?.readyState===WebSocket.OPEN&&$.current.send(JSON.stringify({type:"ice-candidate",candidate:e.candidate}))},V.current.onconnectionstatechange=()=>{const e=V.current.connectionState;"connected"===e?g("connected"):"failed"!==e&&"disconnected"!==e||g("disconnected")},V.current.oniceconnectionstatechange=()=>{const e=V.current.iceConnectionState;"connected"!==e&&"completed"!==e||V.current.getStats().then(e=>{e.forEach(e=>{if("candidate-pair"===e.type&&"succeeded"===e.state){const t=1e3*e.currentRoundTripTime;k(t<50?3:t<100?2:t<200?1:0)}})})}},G=async()=>{try{const e=await V.current.createOffer();await V.current.setLocalDescription(e),$.current?.readyState===WebSocket.OPEN&&$.current.send(JSON.stringify({type:"offer",offer:e}))}catch(e){}},K=async e=>{try{await V.current.setRemoteDescription(new RTCSessionDescription(e));const t=await V.current.createAnswer();await V.current.setLocalDescription(t),$.current?.readyState===WebSocket.OPEN&&$.current.send(JSON.stringify({type:"answer",answer:t}))}catch(t){}},H=async e=>{try{await V.current.setRemoteDescription(new RTCSessionDescription(e))}catch(t){}},Q=async e=>{try{await V.current.addIceCandidate(new RTCIceCandidate(e))}catch(t){}},X=()=>{g("disconnected"),_()},Y=e=>{},Z=()=>{if(L.current){L.current.getTracks().forEach(e=>e.stop());const e=D.current.getVideoTracks()[0],t=V.current.getSenders().find(e=>e.track&&"video"===e.track.kind);t&&e&&t.replaceTrack(e),L.current=null,v(!1),$.current?.readyState===WebSocket.OPEN&&$.current.send(JSON.stringify({type:"screen-share-stopped"}))}},_=()=>{document.pictureInPictureElement&&document.exitPictureInPicture(),D.current&&D.current.getTracks().forEach(e=>e.stop()),L.current&&L.current.getTracks().forEach(e=>e.stop()),V.current&&V.current.close(),$.current&&$.current.close(),B.current&&clearInterval(B.current)};return t.jsxs("div",{className:"min-h-screen bg-[#1A1A1A] flex flex-col",children:[t.jsx("div",{className:"bg-[#2A2A2A] border-b border-[#3A3A3A] px-6 py-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("h1",{className:"text-[20px] font-bold text-white",children:"화상 통화"}),t.jsxs("div",{className:"flex items-center gap-2 text-[#929292]",children:[t.jsx(n,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"1:1 세션"})]})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[0===S?t.jsx(l,{className:"w-5 h-5 text-red-500"}):t.jsx(o,{className:"w-5 h-5 "+(3===S?"text-green-500":2===S?"text-yellow-500":"text-orange-500")}),t.jsx("span",{className:"text-sm text-[#929292]",children:"connected"===h?"연결됨":"connecting"===h?"연결 중...":"연결 끊김"})]}),N&&t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-blue-500/20 rounded-full",children:[t.jsx(s,{className:"w-4 h-4 text-blue-500"}),t.jsx("span",{className:"text-sm text-blue-500",children:"화면 공유 중"})]}),"connected"===h&&t.jsx("div",{className:"text-white font-mono",children:(e=>{const t=Math.floor(e/3600),r=Math.floor(e%3600/60),n=e%60;return t>0?`${t}:${r.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`:`${r}:${n.toString().padStart(2,"0")}`})(b)}),O&&"connected"===h&&t.jsx("button",{onClick:async()=>{if(O)try{!T&&W.current?(await W.current.requestPictureInPicture(),E(!0)):document.pictureInPictureElement&&(await document.exitPictureInPicture(),E(!1))}catch(e){}},className:"p-2 rounded-lg hover:bg-[#3A3A3A] transition-colors",title:T?"PiP 모드 종료":"PiP 모드",children:T?t.jsx(c,{className:"w-5 h-5 text-white"}):t.jsx(a,{className:"w-5 h-5 text-white"})})]})]})}),t.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:"connecting"===h?t.jsxs("div",{className:"text-center",children:[t.jsx(i,{className:"w-16 h-16 text-[#00C471] animate-spin mx-auto mb-4"}),t.jsx("p",{className:"text-white text-lg mb-2",children:"연결 중..."}),t.jsx("p",{className:"text-[#929292] text-sm",children:"잠시만 기다려주세요"})]}):"failed"===h?t.jsxs("div",{className:"text-center",children:[t.jsx(l,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),t.jsx("p",{className:"text-white text-lg mb-2",children:"연결 실패"}),t.jsx("p",{className:"text-[#929292] text-sm mb-4",children:"네트워크 연결을 확인해주세요"}),t.jsx("button",{onClick:()=>window.location.reload(),className:"px-6 py-2 bg-[#00C471] text-white rounded-lg hover:bg-[#00B267]",children:"다시 시도"})]}):t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-6xl",children:[t.jsxs("div",{className:"relative bg-[#2A2A2A] rounded-[20px] overflow-hidden aspect-video",children:[t.jsx("video",{ref:W,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),t.jsx("div",{className:"absolute bottom-4 left-4 bg-black/60 backdrop-blur-sm rounded-lg p-3",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("img",{src:I.avatar,alt:I.name,className:"w-10 h-10 rounded-full object-cover"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-white font-medium",children:I.name}),t.jsxs("p",{className:"text-[#929292] text-sm",children:["Level ",I.level]})]})]})}),t.jsx("div",{className:"absolute top-4 right-4 flex items-center gap-2"})]}),t.jsxs("div",{className:"relative bg-[#2A2A2A] rounded-[20px] overflow-hidden aspect-video",children:[t.jsx("video",{ref:M,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover "+(j?"":"hidden")}),!j&&t.jsx("div",{className:"w-full h-full flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"w-24 h-24 bg-[#3A3A3A] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("span",{className:"text-[#929292] text-3xl",children:"👤"})}),t.jsx("p",{className:"text-[#929292]",children:"카메라가 꺼져있습니다"})]})}),t.jsx("div",{className:"absolute bottom-4 right-4 flex items-center gap-2",children:f&&t.jsx("div",{className:"bg-red-500/80 px-3 py-1 rounded-full",children:t.jsx("span",{className:"text-white text-sm",children:"음소거"})})})]})]})}),t.jsx("div",{className:"p-6 flex justify-center",children:t.jsx(r,{isMuted:f,isVideoOn:j,isScreenSharing:N,currentLanguage:P,onToggleMute:()=>{const e=!f;p(e),D.current&&D.current.getAudioTracks().forEach(t=>{t.enabled=!e})},onToggleVideo:()=>{const e=!j;w(e),D.current&&D.current.getVideoTracks().forEach(t=>{t.enabled=e})},onToggleScreenShare:async()=>{if(N)Z();else try{const e=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1});L.current=e;const t=e.getVideoTracks()[0],r=V.current.getSenders().find(e=>e.track&&"video"===e.track.kind);r&&r.replaceTrack(t),t.onended=()=>{Z()},v(!0),$.current?.readyState===WebSocket.OPEN&&$.current.send(JSON.stringify({type:"screen-share-started"}))}catch(e){}},onToggleLanguage:()=>{const e="en"===P?"ko":"en";A(e),$.current?.readyState===WebSocket.OPEN&&$.current.send(JSON.stringify({type:"language-change",language:e}))},onEndCall:()=>{_(),m("/sessions")},showVideo:!0,showScreenShare:!0,showLanguageToggle:!0,showSettings:!1,showFullscreen:!1,showParticipants:!1,className:"connected"!==h?"opacity-50 pointer-events-none":"",variant:"dark"})})]})}export{m as default};
