import{b as e,z as t}from"./vendor-chunk-D6LsFSV7.js";import{V as a}from"./VideoControls-chunk-Cv29t7G7.js";import{s as n,f as s,t as r,L as c,o as l,w as i,x as o,U as u,y as d,z as m,D as x,F as g,I as h}from"./ui-vendor-chunk-CYPVLLJ1.js";import{u as p,e as b}from"./react-vendor-chunk-CMkIwBz9.js";function f({isActive:a=!1,onTranscript:i,language:o="en",targetLanguages:u=[],enableTranslation:d=!1,className:m=""}){const[x,g]=e.useState(!1),[h,p]=e.useState(!1),[b,f]=e.useState(null),[v,w]=e.useState(0),N=e.useRef(null),j=e.useRef(null),k=e.useRef(null),y=e.useRef(null),S=e.useRef(null),C="wss://api.languagemate.kr/ws",T=e.useCallback(async()=>{try{N.current||(N.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3})),await N.current.audioWorklet.addModule("/audioProcessor.js");const e=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:16e3,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});j.current=e;const t=N.current.createMediaStreamSource(e);k.current=new AudioWorkletNode(N.current,"pcm-processor");const a=N.current.createAnalyser();a.fftSize=256;const n=new Uint8Array(a.frequencyBinCount);t.connect(a),t.connect(k.current);const s=()=>{if(!x)return;a.getByteFrequencyData(n);const e=n.reduce((e,t)=>e+t)/n.length;w(Math.min(100,e)),requestAnimationFrame(s)};return s(),k.current.port.onmessage=e=>{y.current?.readyState===WebSocket.OPEN&&y.current.send(e.data.audioData)},!0}catch(e){return f(e.message),!1}},[x]),E=e.useCallback(()=>{if(y.current?.readyState===WebSocket.OPEN)return;const e=new WebSocket(`${C}/api/transcribe/stream`);e.onopen=()=>{p(!0),f(null),e.send(JSON.stringify({type:"config",language:o,model:"whisper-large-v3-turbo",enableTranslation:d,targetLanguages:u}))},e.onmessage=e=>{try{const t=JSON.parse(e.data);"transcription"===t.type?i?.({text:t.text,isFinal:t.is_final,timestamp:t.timestamp,confidence:t.confidence,language:t.language,translations:t.translations||{}}):"error"===t.type&&f(t.message)}catch(t){}},e.onerror=e=>{f("Connection error")},e.onclose=()=>{p(!1),x&&!S.current&&(S.current=setTimeout(()=>{S.current=null,E()},3e3))},y.current=e},[o,i,x,C,d,u]),P=e.useCallback(async()=>{if(x)g(!1),y.current&&(y.current.close(),y.current=null),k.current&&(k.current.disconnect(),k.current=null),j.current&&(j.current.getTracks().forEach(e=>e.stop()),j.current=null),S.current&&(clearTimeout(S.current),S.current=null),w(0);else{g(!0),f(null);await T()?E():g(!1)}},[x,T,E]);return e.useEffect(()=>{(a&&!x||!a&&x)&&P()},[a]),e.useEffect(()=>()=>{y.current&&y.current.close(),j.current&&j.current.getTracks().forEach(e=>e.stop()),S.current&&clearTimeout(S.current)},[]),t.jsxs("div",{className:`flex items-center gap-3 ${m}`,children:[t.jsxs("button",{onClick:P,disabled:!a&&x,className:`\n          relative p-3 rounded-full transition-all\n          ${x?"bg-red-500 hover:bg-red-600 text-white":"bg-[#2A2A2A] hover:bg-[#3A3A3A] text-white"}\n          ${!a&&x?"opacity-50 cursor-not-allowed":""}\n        `,children:[x?t.jsx(n,{className:"w-5 h-5"}):t.jsx(s,{className:"w-5 h-5"}),x&&t.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-white opacity-30 animate-ping",style:{animationDuration:`${Math.max(.5,2-v/50)}s`}})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[x&&t.jsx(t.Fragment,{children:h?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(r,{className:"w-4 h-4 text-green-500"}),t.jsx("div",{className:"w-20 h-2 bg-[#1A1A1A] rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-green-500 transition-all duration-100",style:{width:`${v}%`}})})]}):t.jsx(c,{className:"w-4 h-4 text-yellow-500 animate-spin"})}),b&&t.jsxs("div",{className:"flex items-center gap-1 text-red-500",children:[t.jsx(l,{className:"w-4 h-4"}),t.jsx("span",{className:"text-xs",children:b})]})]}),x&&t.jsx("span",{className:"text-xs text-[#929292]",children:h?"실시간 자막 활성":"연결 중..."})]})}function v({transcripts:a=[],isVisible:n=!0,position:s="bottom",maxLines:r=2,userLanguage:c="en",showOriginal:l=!1,className:o=""}){const[u,d]=e.useState([]),m=e.useRef(null),x=e.useRef(null);if(e.useEffect(()=>{if(a.length>0){const e=a[a.length-1];d(t=>{const a=[...t],n=a.findIndex(t=>t.timestamp===e.timestamp&&!t.isFinal);return n>=0?a[n]=e:a.push(e),a.length>r?a.slice(-r):a}),x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{d(e=>e.slice(-1))},5e3)}},[a,r]),e.useEffect(()=>()=>{x.current&&clearTimeout(x.current)},[]),!n||0===u.length)return null;return t.jsx("div",{ref:m,className:`\n        fixed z-50 pointer-events-none\n        ${{bottom:"bottom-20 left-1/2 transform -translate-x-1/2",top:"top-20 left-1/2 transform -translate-x-1/2",overlay:"bottom-4 left-4 right-4"}[s]}\n        ${o}\n      `,children:t.jsxs("div",{className:"bg-black/80 backdrop-blur-sm rounded-lg px-6 py-3 max-w-2xl",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(i,{className:"w-4 h-4 text-white/60"}),t.jsx("span",{className:"text-xs text-white/60",children:"실시간 자막"})]}),t.jsx("div",{className:"space-y-1",children:u.map((e,a)=>{const n=e.translations?.[c]||e.text,s=e.translations?.[c]&&e.translations[c]!==e.text;return t.jsxs("div",{className:"text-center",children:[t.jsx("p",{className:`\n                    text-white leading-relaxed\n                    transition-all duration-300\n                    ${e.isFinal?"text-lg":"text-base opacity-70"}\n                    ${a===u.length-1?"animate-fade-in":""}\n                  `,children:n}),l&&s&&t.jsxs("p",{className:"text-sm text-white/60 mt-1",children:["(",e.text,")"]})]},`${e.timestamp}-${a}`)})})]})})}function w({isEnabled:e,onToggle:a,position:n,onPositionChange:s,showOriginal:r,onShowOriginalChange:c,userLanguage:l,onLanguageChange:u,className:d=""}){return t.jsxs("div",{className:`flex items-center gap-4 ${d}`,children:[t.jsxs("button",{onClick:a,className:`\n          flex items-center gap-2 px-3 py-2 rounded-lg transition-all\n          ${e?"bg-[var(--blue)] text-white":"bg-[var(--black-400)] text-[var(--black-200)] hover:bg-[var(--black-300)]"}\n        `,children:[t.jsx(i,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"자막"})]}),e&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-sm text-[#929292]",children:"위치:"}),t.jsx("div",{className:"flex gap-1",children:[{value:"bottom",label:"하단"},{value:"top",label:"상단"},{value:"overlay",label:"오버레이"}].map(e=>t.jsx("button",{onClick:()=>s(e.value),className:`\n                    px-2 py-1 text-xs rounded transition-all\n                    ${n===e.value?"bg-[var(--blue)] text-white":"bg-[var(--black-400)] text-[var(--black-200)] hover:bg-[var(--black-300)]"}\n                  `,children:e.label},e.value))})]}),u&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(o,{className:"w-4 h-4 text-[var(--black-200)]"}),t.jsx("select",{value:l,onChange:e=>u(e.target.value),className:"bg-[var(--black-400)] text-white text-sm rounded px-2 py-1 outline-none focus:ring-2 focus:ring-[var(--blue)]",children:[{value:"en",label:"English"},{value:"ko",label:"한국어"},{value:"ja",label:"日本語"},{value:"zh",label:"中文"},{value:"es",label:"Español"},{value:"fr",label:"Français"}].map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))})]}),c&&t.jsx("button",{onClick:()=>c(!r),className:`\n                text-xs px-2 py-1 rounded transition-all\n                ${r?"bg-[var(--black-300)] text-white":"bg-[var(--black-400)] text-[var(--black-200)] hover:bg-[var(--black-300)]"}\n              `,children:"원본 표시"})]})]})}function N(){const n=p(),{roomId:s}=b(),[r,l]=e.useState("connecting"),[i,o]=e.useState(!1),[N,j]=e.useState(!0),[k,y]=e.useState(!1),[S,C]=e.useState(0),[T,E]=e.useState(3),[P,O]=e.useState("en"),[R,L]=e.useState(!1),[$,A]=e.useState(!1),[D,I]=e.useState(!1),[W,J]=e.useState(!1),[M,F]=e.useState([]),[V,z]=e.useState("bottom"),[q,U]=e.useState("en"),[B,G]=e.useState(!1),[K,_]=e.useState(!0),[H,Q]=e.useState({name:"John Doe",avatar:"/assets/basicProfilePic.png",level:"B2",nativeLanguage:"English",learningLanguage:"Korean"}),X=e.useRef(null),Y=e.useRef(null),Z=e.useRef(null),ee=e.useRef(null),te=e.useRef(null),ae=e.useRef(null),ne=e.useRef(null),se=e.useRef(null),re={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};e.useEffect(()=>(A("pictureInPictureEnabled"in document),ce(),()=>{fe()}),[s]),e.useEffect(()=>("connected"===r?se.current=setInterval(()=>{C(e=>e+1)},1e3):se.current&&clearInterval(se.current),()=>{se.current&&clearInterval(se.current)}),[r]);const ce=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"},audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});X.current=e,te.current&&(te.current.srcObject=e),le(),ie()}catch(e){l("failed")}},le=()=>{ne.current=new WebSocket(`wss://your-signaling-server.com/room/${s}`),ne.current.onopen=()=>{ne.current.send(JSON.stringify({type:"join",roomId:s}))},ne.current.onmessage=async e=>{const t=JSON.parse(e.data);switch(t.type){case"offer":await ue(t.offer);break;case"answer":await de(t.answer);break;case"ice-candidate":await me(t.candidate);break;case"user-joined":await oe();break;case"user-left":xe();break;case"screen-share-started":ge(!0);break;case"screen-share-stopped":ge(!1);break;case"subtitle":t.subtitle&&D&&F(e=>[...e,{...t.subtitle,isRemote:!0,timestamp:Date.now()}]);break;case"language-change":O(t.language)}},ne.current.onerror=e=>{l("failed")},ne.current.onclose=()=>{l("disconnected")}},ie=()=>{ee.current=new RTCPeerConnection(re),X.current&&X.current.getTracks().forEach(e=>{ee.current.addTrack(e,X.current)}),ee.current.ontrack=e=>{Y.current=e.streams[0],ae.current&&(ae.current.srcObject=e.streams[0]),l("connected")},ee.current.onicecandidate=e=>{e.candidate&&ne.current?.readyState===WebSocket.OPEN&&ne.current.send(JSON.stringify({type:"ice-candidate",candidate:e.candidate}))},ee.current.onconnectionstatechange=()=>{const e=ee.current.connectionState;"connected"===e?l("connected"):"failed"!==e&&"disconnected"!==e||l("disconnected")},ee.current.oniceconnectionstatechange=()=>{const e=ee.current.iceConnectionState;"connected"!==e&&"completed"!==e||ee.current.getStats().then(e=>{e.forEach(e=>{if("candidate-pair"===e.type&&"succeeded"===e.state){const t=1e3*e.currentRoundTripTime;E(t<50?3:t<100?2:t<200?1:0)}})})}},oe=async()=>{try{const e=await ee.current.createOffer();await ee.current.setLocalDescription(e),ne.current?.readyState===WebSocket.OPEN&&ne.current.send(JSON.stringify({type:"offer",offer:e}))}catch(e){}},ue=async e=>{try{await ee.current.setRemoteDescription(new RTCSessionDescription(e));const t=await ee.current.createAnswer();await ee.current.setLocalDescription(t),ne.current?.readyState===WebSocket.OPEN&&ne.current.send(JSON.stringify({type:"answer",answer:t}))}catch(t){}},de=async e=>{try{await ee.current.setRemoteDescription(new RTCSessionDescription(e))}catch(t){}},me=async e=>{try{await ee.current.addIceCandidate(new RTCIceCandidate(e))}catch(t){}},xe=()=>{l("disconnected"),fe()},ge=e=>{},he=()=>{if(Z.current){Z.current.getTracks().forEach(e=>e.stop());const e=X.current.getVideoTracks()[0],t=ee.current.getSenders().find(e=>e.track&&"video"===e.track.kind);t&&e&&t.replaceTrack(e),Z.current=null,y(!1),ne.current?.readyState===WebSocket.OPEN&&ne.current.send(JSON.stringify({type:"screen-share-stopped"}))}},pe=e.useCallback(e=>{F(t=>[...t,{...e,timestamp:Date.now()}]),ne.current?.readyState===WebSocket.OPEN&&ne.current.send(JSON.stringify({type:"subtitle",subtitle:e}))},[]),be=e.useCallback(()=>{const e=new Set([q]);if(H.nativeLanguage){const t=H.nativeLanguage.toLowerCase().substring(0,2);e.add(t)}return e.add(P),Array.from(e)},[q,P,H.nativeLanguage]),fe=()=>{document.pictureInPictureElement&&document.exitPictureInPicture(),X.current&&X.current.getTracks().forEach(e=>e.stop()),Z.current&&Z.current.getTracks().forEach(e=>e.stop()),ee.current&&ee.current.close(),ne.current&&ne.current.close(),se.current&&clearInterval(se.current)};return t.jsxs("div",{className:"min-h-screen bg-[var(--black-600)] flex flex-col",children:[t.jsx("div",{className:"bg-[var(--black-400)] border-b border-[var(--black-400)] px-6 py-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("h1",{className:"text-[20px] font-bold text-white",children:"화상 통화"}),t.jsxs("div",{className:"flex items-center gap-2 text-[var(--black-200)]",children:[t.jsx(u,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"1:1 세션"})]})]}),t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[0===T?t.jsx(g,{className:"w-5 h-5 text-[var(--red)]"}):t.jsx(h,{className:"w-5 h-5 "+(3===T?"text-[var(--green-500)]":2===T?"text-[var(--warning-yellow)]":"text-[var(--blue)]")}),t.jsx("span",{className:"text-sm text-[var(--black-200)]",children:"connected"===r?"연결됨":"connecting"===r?"연결 중...":"연결 끊김"})]}),k&&t.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-[rgba(66,133,244,0.2)] rounded-full",children:[t.jsx(d,{className:"w-4 h-4 text-[var(--blue)]"}),t.jsx("span",{className:"text-sm text-[var(--blue)]",children:"화면 공유 중"})]}),"connected"===r&&t.jsx("div",{className:"text-white font-mono",children:(e=>{const t=Math.floor(e/3600),a=Math.floor(e%3600/60),n=e%60;return t>0?`${t}:${a.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`:`${a}:${n.toString().padStart(2,"0")}`})(S)}),$&&"connected"===r&&t.jsx("button",{onClick:async()=>{if($)try{!R&&ae.current?(await ae.current.requestPictureInPicture(),L(!0)):document.pictureInPictureElement&&(await document.exitPictureInPicture(),L(!1))}catch(e){}},className:"p-2 rounded-lg hover:bg-[var(--black-400)] transition-colors",title:R?"PiP 모드 종료":"PiP 모드",children:R?t.jsx(m,{className:"w-5 h-5 text-white"}):t.jsx(x,{className:"w-5 h-5 text-white"})})]})]})}),t.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:"connecting"===r?t.jsxs("div",{className:"text-center",children:[t.jsx(c,{className:"w-16 h-16 text-[var(--green-500)] animate-spin mx-auto mb-4"}),t.jsx("p",{className:"text-white text-lg mb-2",children:"연결 중..."}),t.jsx("p",{className:"text-[var(--black-200)] text-sm",children:"잠시만 기다려주세요"})]}):"failed"===r?t.jsxs("div",{className:"text-center",children:[t.jsx(g,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),t.jsx("p",{className:"text-white text-lg mb-2",children:"연결 실패"}),t.jsx("p",{className:"text-[var(--black-200)] text-sm mb-4",children:"네트워크 연결을 확인해주세요"}),t.jsx("button",{onClick:()=>window.location.reload(),className:"px-6 py-2 bg-[var(--green-500)] text-white rounded-lg hover:bg-[var(--green-600)]",children:"다시 시도"})]}):t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-6xl",children:[t.jsxs("div",{className:"relative bg-[var(--black-400)] rounded-[20px] overflow-hidden aspect-video",children:[t.jsx("video",{ref:ae,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),t.jsx("div",{className:"absolute bottom-4 left-4 bg-black/60 backdrop-blur-sm rounded-lg p-3",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("img",{src:H.avatar,alt:H.name,className:"w-10 h-10 rounded-full object-cover"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-white font-medium",children:H.name}),t.jsxs("p",{className:"text-[var(--black-200)] text-sm",children:["Level ",H.level]})]})]})}),t.jsx("div",{className:"absolute top-4 right-4 flex items-center gap-2"})]}),t.jsxs("div",{className:"relative bg-[var(--black-400)] rounded-[20px] overflow-hidden aspect-video",children:[t.jsx("video",{ref:te,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full h-full object-cover "+(N?"":"hidden")}),!N&&t.jsx("div",{className:"w-full h-full flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"w-24 h-24 bg-[var(--black-400)] rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("span",{className:"text-[var(--black-200)] text-3xl",children:"👤"})}),t.jsx("p",{className:"text-[var(--black-200)]",children:"카메라가 꺼져있습니다"})]})}),t.jsx("div",{className:"absolute bottom-4 right-4 flex items-center gap-2",children:i&&t.jsx("div",{className:"bg-[rgba(234,67,53,0.8)] px-3 py-1 rounded-full",children:t.jsx("span",{className:"text-white text-sm",children:"음소거"})})})]})]})}),t.jsx(v,{transcripts:M,isVisible:D,position:V,maxLines:2,userLanguage:q,showOriginal:B}),t.jsxs("div",{className:"p-6 flex flex-col items-center gap-4",children:[t.jsx(w,{isEnabled:D,onToggle:()=>{I(e=>!e),J(!D)},position:V,onPositionChange:z,showOriginal:B,onShowOriginalChange:G,userLanguage:q,onLanguageChange:U,className:"mb-2"}),D&&t.jsx(f,{isActive:W&&"connected"===r,onTranscript:pe,language:P,targetLanguages:be(),enableTranslation:K,className:"mb-2"}),t.jsx(a,{isMuted:i,isVideoOn:N,isScreenSharing:k,currentLanguage:P,onToggleMute:()=>{const e=!i;o(e),X.current&&X.current.getAudioTracks().forEach(t=>{t.enabled=!e})},onToggleVideo:()=>{const e=!N;j(e),X.current&&X.current.getVideoTracks().forEach(t=>{t.enabled=e})},onToggleScreenShare:async()=>{if(k)he();else try{const e=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1});Z.current=e;const t=e.getVideoTracks()[0],a=ee.current.getSenders().find(e=>e.track&&"video"===e.track.kind);a&&a.replaceTrack(t),t.onended=()=>{he()},y(!0),ne.current?.readyState===WebSocket.OPEN&&ne.current.send(JSON.stringify({type:"screen-share-started"}))}catch(e){}},onToggleLanguage:()=>{const e="en"===P?"ko":"en";O(e),ne.current?.readyState===WebSocket.OPEN&&ne.current.send(JSON.stringify({type:"language-change",language:e}))},onEndCall:()=>{fe(),n("/sessions")},showVideo:!0,showScreenShare:!0,showLanguageToggle:!0,showSettings:!1,showFullscreen:!1,showParticipants:!1,className:"connected"!==r?"opacity-50 pointer-events-none":"",variant:"dark"})]})]})}export{N as default};
